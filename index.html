<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Snake: Windows Media Controls Edition</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <meta property="og:title" content="Snake: Windows Media Controls Edition">
    <meta property="og:description" content="Play snake inside your Windows Media Controls overlay, just like you've always wanted to!">
    <meta property="og:image" content="https://thegoodjakeward.github.io/snake_windows_media_controls_edition/social.png">
    <meta property="og:url" content="https://thegoodjakeward.github.io/snake_windows_media_controls_edition/">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="https://thegoodjakeward.github.io/snake_windows_media_controls_edition/">
    <meta name="twitter:title" content="Snake: Windows Media Controls Edition">
    <meta name="twitter:description" content="Play snake inside your Windows Media Controls overlay, just like you've always wanted to!">
    <meta name="twitter:image" content="https://thegoodjakeward.github.io/snake_windows_media_controls_edition/social.png">
    
    <style>
        body { 
            background: #111; 
            color: #eee; 
            font-family: 'Segoe UI', sans-serif; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            height: 100vh; 
            margin: 0; 
        }
        
        h1 {
            margin: 0 0 20px 0;
            font-weight: 300;
            letter-spacing: 2px;
            color: #0f0;
            text-transform: uppercase;
            text-align:center;
            text-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
        }

        .panel {
            background: #222;
            padding: 2rem;
            border-radius: 8px;
            border: 1px solid #444;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            width: 350px;
        }

        button { 
            padding: 15px 30px; 
            font-size: 18px; 
            cursor: pointer; 
            background: #0f0; 
            color: #000;
            border: none; 
            font-weight: bold; 
            border-radius: 4px; 
            margin-bottom: 20px;
            width: 100%;
        }
        button:hover { background: #0c0; }
        button:disabled { background: #444; color: #888; cursor: not-allowed; }

        .settings-group {
            margin: 15px 0;
            text-align: left;
        }

        label { display: block; margin-bottom: 5px; font-weight: bold; }
        
        select {
            width: 100%;
            padding: 8px;
            background: #333;
            color: #fff;
            border: 1px solid #555;
            border-radius: 4px;
        }

        .slider-container {
            margin-top: 20px;
            text-align: left;
            background: #1a1a1a;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #444;
        }

        input[type=range] {
            width: 100%;
            margin-top: 5px;
            cursor: pointer;
        }

        .instructions { font-size: 0.9em; color: #aaa; margin-top: 20px; line-height: 1.5; }
    </style>
</head>
<body>

    <h1>Snake: Windows Media <br/>Controls Edition</h1>

    <div class="panel">
        <button id="startBtn">INITIALIZE SYSTEM LINK</button>
        
        <div class="settings-group">
            <label for="difficulty">Difficulty Level:</label>
            <select id="difficulty">
                <option value="casual" selected>Casual (8x8 Grid - 1x Pts)</option>
                <option value="gamer">Gamer (16x16 Grid - 2x Pts)</option>
            </select>
        </div>

        <div class="slider-container">
            <label for="bgSlider">Background Matcher</label>
            <div style="font-size: 0.8em; color: #888; margin-bottom: 5px;">
                Use slider OR press <b>Play/Pause</b> in-game to cycle colors.
            </div>
            <input type="range" id="bgSlider" min="0" max="80" value="0">
        </div>

        <div class="instructions">
            <p>1. Click Initialize above.</p>
            <p>2. Press <b>Win + A</b> to open Media Controls.</p>
            <p>3. Press <b>Prev (&#9198;)</b> or <b>Next (&#9197;)</b> to START.</p>
            <p>4. Press <b>Play/Pause</b> to tune background color.</p>
        </div>
    </div>

    <audio id="bgMusic" loop src="music.mp3"></audio>

    <script>
        // --- 1. SETUP ---
        const canvas = document.createElement('canvas'); // create "headless" canvas
        canvas.width = 256;
        canvas.height = 256;
        const ctx = canvas.getContext('2d');
        
        const startBtn = document.getElementById('startBtn');
        const music = document.getElementById('bgMusic');
        const difficultySelect = document.getElementById('difficulty');
        const bgSlider = document.getElementById('bgSlider');

        // Game State Variables
        let gameState = 'MENU'; 
        let highScore = 0;
        let score = 0;
        let snake = [];
        let food = { x: 0, y: 0 };
        let dx = 0; 
        let dy = 0; 
        let inputQueue = [];
        let gameOverTime = 0; // Timestamp for death
        
        // Settings, initialized to default casual settings
        let tileCount = 16; 
        let gridSize = 16;
        let scoreMultiplier = 1;
        let bgGrayValue = 0; // 0-255
        let gameSpeed = 1000 / 6;

        // --- 2. INPUT LISTENERS ---
        
        // Reset on difficulty change
        difficultySelect.onchange = () => {
            if (gameState === 'PLAYING') {
                gameState = 'GAMEOVER';
            } else {
                setDifficulty(); 
            }
        };

        // Real-time Background Update from Slider
        bgSlider.oninput = () => {
            bgGrayValue = parseInt(bgSlider.value);
            draw();
            updateOverlay();
        };

        // Helper to cycle background from Play/Pause Media Key
        function cycleBackgroundColor() {
            bgGrayValue = (bgGrayValue + 10);
            if (bgGrayValue > 90) bgGrayValue = 0;
            
            // Sync the HTML slider to match
            bgSlider.value = bgGrayValue;
            
            draw();
            updateOverlay();
        }

        // --- 3. LOGIC ---

        function setDifficulty() {
            const level = difficultySelect.value;
            if (level === 'casual') { // coarser grid, slower game speed
                tileCount = 8;
                scoreMultiplier = 1;
                gameSpeed = 1000 / 6;
            } else if (level === 'gamer') { // finer grid, faster game speed
                tileCount = 16;
                scoreMultiplier = 2;
                gameSpeed = 1000 / 8;
            }
            gridSize = canvas.width / tileCount;
        }

        function resetGame() {
            setDifficulty();
            
            // Start in middle
            const mid = Math.floor(tileCount / 2);
            snake = [{x: mid, y: mid}, {x: mid-1, y: mid}, {x: mid-2, y: mid}];
            
            score = 3;
            dx = 1; dy = 0; 
            inputQueue = [];
            
            placeFood();
            gameState = 'PLAYING';
            draw();
            updateOverlay(); 
        }

        function placeFood() {
            let valid = false;
            let attempts = 0;
            while (!valid && attempts < 100) {
                food.x = Math.floor(Math.random() * tileCount);
                food.y = Math.floor(Math.random() * tileCount);
                
                valid = true;
                for(let part of snake) {
                    if(part.x === food.x && part.y === food.y) valid = false;
                }
                attempts++;
            }
        }

        function handleInput(type) {
            // Safety Delay Check for Game Over
            if (gameState === 'GAMEOVER') {
                const now = Date.now();
                if (now - gameOverTime < 1000) {
                    // Block input if less than 1 seconds have passed, so you don't clear game over screen accidentally
                    return;
                }
                resetGame();
                return;
            }

            // Start game from Menu
            if (gameState === 'MENU') {
                resetGame();
                return;
            }

            if (type === 'left') inputQueue.push('left');
            if (type === 'right') inputQueue.push('right');
        }

        function update() {
            if (gameState !== 'PLAYING') return;

            if (inputQueue.length > 0) {
                const turn = inputQueue.shift();
                if (turn === 'left') {
                    const temp = dx; dx = dy; dy = -temp;
                } else if (turn === 'right') {
                    const temp = dx; dx = -dy; dy = temp;
                }
            }

            const head = { x: snake[0].x + dx, y: snake[0].y + dy };

            // Wrap Walls
            if (head.x < 0) head.x = tileCount - 1;
            if (head.x >= tileCount) head.x = 0;
            if (head.y < 0) head.y = tileCount - 1;
            if (head.y >= tileCount) head.y = 0;

            for (let part of snake) {
                if (part.x === head.x && part.y === head.y) {
                    gameState = 'GAMEOVER';
                    gameOverTime = Date.now(); // Record time of death
                    if (score > highScore) highScore = score;
                    updateOverlay();
                    return;
                }
            }

            snake.unshift(head);

            if (head.x === food.x && head.y === food.y) {
                score += (1 * scoreMultiplier);
                placeFood();
            } else {
                snake.pop();
            }
        }

        function draw() {
            // Draw Background (Using Slider Value)
            ctx.fillStyle = 'black'; 
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            const gray = bgGrayValue;
            ctx.fillStyle = `rgb(${gray}, ${gray}, ${gray})`;
            ctx.fillRect(4, 4, canvas.width - 8, canvas.height - 8);

            // State Drawing
            if (gameState === 'MENU') {
                drawText("PRESS KEY", "TO START");
                return;
            }

            if (gameState === 'GAMEOVER') {
                // Show "WAIT..." if in the safety lockout period
                const now = Date.now();
                if (now - gameOverTime < 1000) {
                    drawText("GAME OVER", "WAIT...");
                } else {
                    drawText("GAME OVER", `FINAL: ${score}`);
                }
                return;
            }

            // Draw Food
            ctx.fillStyle = '#ff3333';
            ctx.fillRect(food.x * gridSize, food.y * gridSize, gridSize - 2, gridSize - 2);

            // Draw Snake
            for (let i = 0; i < snake.length; i++) {
                ctx.fillStyle = '#00ff00';
                ctx.fillRect(snake[i].x * gridSize, snake[i].y * gridSize, gridSize - 2, gridSize - 2);
            }
        }

        function drawText(line1, line2) {
            ctx.fillStyle = '#0f0';
            ctx.font = 'bold 40px Courier New';
            ctx.textAlign = 'center';
            ctx.fillText(line1, canvas.width/2, canvas.height/2 - 20);
            ctx.fillText(line2, canvas.width/2, canvas.height/2 + 30);
        }

        function updateOverlay() {
            if ('mediaSession' in navigator) {
                let titleText = `Score: ${score}`;
                let artistText = `High Score: ${highScore}`;

                if (gameState === 'MENU') {
                    titleText = "Snake: Windows Media Controls Edition";
                    artistText = "Press Prev/Next Track to START...";
                } else if (gameState === 'GAMEOVER') {
                    titleText = "GAME OVER";
                    artistText = `Final: ${score} | Best: ${highScore}`;
                }

                navigator.mediaSession.metadata = new MediaMetadata({
                    title: titleText,
                    artist: artistText,
                    artwork: [{ src: canvas.toDataURL('image/png'), sizes: '256x256', type: 'image/png' }] // pushes current game screen to album art
                });
            }
        }

        // --- 4. LOOPS ---

        function gameLoop() {
            update();
            draw();
            setTimeout(() => requestAnimationFrame(gameLoop), gameSpeed); 
        }

        setInterval(updateOverlay, 50); // Changing this value lower doesn't change anything since we are limited by how fast the metadata can be updated

        startBtn.onclick = () => {
            // Reset and Prep Music
            music.currentTime = 0;
            music.volume = 1.0; 
        
            music.play().then(() => {                
                setDifficulty();
                
                if ('mediaSession' in navigator) {
                    // Force the playback state to 'playing' so Windows notices
                    navigator.mediaSession.playbackState = 'playing';
        
                    navigator.mediaSession.setActionHandler('previoustrack', () => handleInput('left'));
                    navigator.mediaSession.setActionHandler('nexttrack', () => handleInput('right'));
                    
                    const handleToggle = () => {
                        cycleBackgroundColor();
                        music.play(); // explicitly play the music again so that play/puase doesn't stop the music at all
                        navigator.mediaSession.playbackState = 'playing';
                    };
        
                    navigator.mediaSession.setActionHandler('play', handleToggle);
                    navigator.mediaSession.setActionHandler('pause', handleToggle);
                    
                    // Initial overlay update to "kick" Windows into showing the UI
                    updateOverlay();
                }
        
                gameLoop();
                startBtn.textContent = "LINK ACTIVE - OPEN WIN+A";
                startBtn.disabled = true;
            }).catch(err => {
                console.error("Audio playback failed:", err);
                alert("Audio Error: " + err.message);
            });
        };
    </script>
</body>
</html>








