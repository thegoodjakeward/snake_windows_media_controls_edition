<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Snake: Windows Media Controls Edition</title>
    <style>
        body { 
            background: #111; 
            color: #eee; 
            font-family: 'Segoe UI', sans-serif; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            height: 100vh; 
            margin: 0; 
        }
        
        h1 {
            margin: 0 0 20px 0;
            font-weight: 300;
            letter-spacing: 2px;
            color: #0f0;
            text-transform: uppercase;
            text-align:center;
            text-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
        }

        .panel {
            background: #222;
            padding: 2rem;
            border-radius: 8px;
            border: 1px solid #444;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            width: 350px;
        }

        button { 
            padding: 15px 30px; 
            font-size: 18px; 
            cursor: pointer; 
            background: #0f0; 
            color: #000;
            border: none; 
            font-weight: bold; 
            border-radius: 4px; 
            margin-bottom: 20px;
            width: 100%;
        }
        button:hover { background: #0c0; }
        button:disabled { background: #444; color: #888; cursor: not-allowed; }

        .settings-group { margin: 15px 0; text-align: left; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        
        select {
            width: 100%;
            padding: 8px;
            background: #333;
            color: #fff;
            border: 1px solid #555;
            border-radius: 4px;
        }

        .slider-container {
            margin-top: 20px;
            text-align: left;
            background: #1a1a1a;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #444;
        }

        input[type=range] { width: 100%; margin-top: 5px; cursor: pointer; }
        .instructions { font-size: 0.9em; color: #aaa; margin-top: 20px; line-height: 1.5; }
    </style>
</head>
<body>

    <h1>Snake: Windows Media <br/>Controls Edition</h1>

    <div class="panel">
        <button id="startBtn">INITIALIZE SYSTEM LINK</button>
        
        <div class="settings-group">
            <label for="difficulty">Difficulty Level:</label>
            <select id="difficulty">
                <option value="casual" selected>Casual (8x8 Grid - 1x Pts)</option>
                <option value="gamer">Gamer (16x16 Grid - 2x Pts)</option>
            </select>
        </div>

        <div class="slider-container">
            <label for="bgSlider">Background Matcher</label>
            <div style="font-size: 0.8em; color: #888; margin-bottom: 5px;">
                Use slider OR press <b>Play/Pause</b> in-game to cycle colors.
            </div>
            <input type="range" id="bgSlider" min="0" max="80" value="0">
        </div>

        <div class="instructions">
            <p>1. Click Initialize above.</p>
            <p>2. Press <b>Win + A</b> to open Media Controls.</p>
            <p>3. Press <b>Prev ($|<<$)</b> or <b>Next ($>>|$)</b> to START.</p>
        </div>
    </div>

    <audio id="silentAudio" loop>
        <source src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAA==" type="audio/wav">
    </audio>

    <script>
        const canvas = document.createElement('canvas');
        canvas.width = 256; canvas.height = 256;
        const ctx = canvas.getContext('2d');
        
        const startBtn = document.getElementById('startBtn');
        const silentAudio = document.getElementById('silentAudio');
        const difficultySelect = document.getElementById('difficulty');
        const bgSlider = document.getElementById('bgSlider');

        let gameState = 'MENU'; 
        let highScore = 0, score = 0, snake = [], food = { x: 0, y: 0 };
        let dx = 0, dy = 0, inputQueue = [], gameOverTime = 0;
        let tileCount = 16, gridSize = 16, scoreMultiplier = 1, bgGrayValue = 0, gameSpeed = 1000 / 6;

        difficultySelect.onchange = () => {
            if (gameState === 'PLAYING' || gameState === 'GAMEOVER') resetGame();
            else setDifficulty(); 
        };

        bgSlider.oninput = () => {
            bgGrayValue = parseInt(bgSlider.value);
            draw(); updateOverlay();
        };

        function cycleBackgroundColor() {
            bgGrayValue = (bgGrayValue + 10);
            if (bgGrayValue > 80) bgGrayValue = 0;
            bgSlider.value = bgGrayValue;
            draw(); updateOverlay();
        }

        function setDifficulty() {
            const level = difficultySelect.value;
            if (level === 'casual') { tileCount = 8; scoreMultiplier = 1; gameSpeed = 1000 / 6; }
            else { tileCount = 16; scoreMultiplier = 2; gameSpeed = 1000 / 8; }
            gridSize = canvas.width / tileCount;
        }

        function resetGame() {
            setDifficulty();
            const mid = Math.floor(tileCount / 2);
            snake = [{x: mid, y: mid}, {x: mid-1, y: mid}, {x: mid-2, y: mid}];
            score = 0; dx = 1; dy = 0; inputQueue = [];
            placeFood();
            gameState = 'PLAYING';
            draw(); updateOverlay(); 
        }

        function placeFood() {
            let valid = false;
            while (!valid) {
                food.x = Math.floor(Math.random() * tileCount);
                food.y = Math.floor(Math.random() * tileCount);
                valid = !snake.some(p => p.x === food.x && p.y === food.y);
            }
        }

        function handleInput(type) {
            if (gameState === 'GAMEOVER') {
                if (Date.now() - gameOverTime < 1500) return;
                resetGame(); return;
            }
            if (gameState === 'MENU') { resetGame(); return; }
            if (type === 'left') inputQueue.push('left');
            if (type === 'right') inputQueue.push('right');
        }

        function update() {
            if (gameState !== 'PLAYING') return;
            if (inputQueue.length > 0) {
                const turn = inputQueue.shift();
                const temp = dx;
                if (turn === 'left') { dx = dy; dy = -temp; }
                else if (turn === 'right') { dx = -dy; dy = temp; }
            }
            const head = { x: snake[0].x + dx, y: snake[0].y + dy };
            if (head.x < 0) head.x = tileCount - 1;
            if (head.x >= tileCount) head.x = 0;
            if (head.y < 0) head.y = tileCount - 1;
            if (head.y >= tileCount) head.y = 0;
            if (snake.some(p => p.x === head.x && p.y === head.y)) {
                gameState = 'GAMEOVER'; gameOverTime = Date.now();
                if (score > highScore) highScore = score;
                updateOverlay(); return;
            }
            snake.unshift(head);
            if (head.x === food.x && head.y === food.y) {
                score += (1 * scoreMultiplier); placeFood();
            } else { snake.pop(); }
        }

        function draw() {
            ctx.fillStyle = 'black'; 
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = `rgb(${bgGrayValue}, ${bgGrayValue}, ${bgGrayValue})`;
            ctx.fillRect(4, 4, canvas.width - 8, canvas.height - 8);

            if (gameState === 'MENU') drawText("READY?", "START KEY");
            else if (gameState === 'GAMEOVER') {
                if (Date.now() - gameOverTime < 1500) drawText("GAME OVER", "WAIT...");
                else drawText("GAME OVER", `SCORE: ${score}`);
            } else {
                ctx.fillStyle = '#ff3333';
                ctx.fillRect(food.x * gridSize, food.y * gridSize, gridSize - 2, gridSize - 2);
                snake.forEach((p, i) => {
                    ctx.fillStyle = (i === 0) ? '#ccffcc' : '#00ff00';
                    ctx.fillRect(p.x * gridSize, p.y * gridSize, gridSize - 2, gridSize - 2);
                });
            }
        }

        function drawText(l1, l2) {
            ctx.fillStyle = '#0f0'; ctx.font = 'bold 32px Courier New';
            ctx.textAlign = 'center';
            ctx.fillText(l1, canvas.width/2, canvas.height/2 - 15);
            ctx.fillText(l2, canvas.width/2, canvas.height/2 + 25);
        }

        function updateOverlay() {
            if ('mediaSession' in navigator) {
                let t = `Score: ${score}`, a = `Best: ${highScore}`;
                if (gameState === 'MENU') { t = "Snake: WMCE"; a = "Prev/Next to Start"; }
                else if (gameState === 'GAMEOVER') { t = "GAME OVER"; a = `Final: ${score}`; }

                navigator.mediaSession.metadata = new MediaMetadata({
                    title: t, artist: a,
                    artwork: [{ src: canvas.toDataURL('image/png'), sizes: '256x256', type: 'image/png' }]
                });
            }
        }

        function gameLoop() { update(); draw(); setTimeout(() => requestAnimationFrame(gameLoop), gameSpeed); }
        setInterval(updateOverlay, 150);

        startBtn.onclick = () => {
            silentAudio.play().then(() => {
                setDifficulty();
                if ('mediaSession' in navigator) {
                    navigator.mediaSession.setActionHandler('previoustrack', () => handleInput('left'));
                    navigator.mediaSession.setActionHandler('nexttrack', () => handleInput('right'));
                    navigator.mediaSession.setActionHandler('play', () => { cycleBackgroundColor(); silentAudio.play(); });
                    navigator.mediaSession.setActionHandler('pause', () => { cycleBackgroundColor(); silentAudio.play(); });
                }
                gameLoop();
                startBtn.textContent = "LINK ACTIVE - OPEN WIN+A";
                startBtn.disabled = true;
            }).catch(err => {
                alert("Please interact with the page first to allow audio playback.");
            });
        };
    </script>
</body>
</html>